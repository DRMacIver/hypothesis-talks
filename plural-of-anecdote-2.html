<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>The plural of anecdote is not test suite</title>

    <meta name="description" content="Making your tests do the work for you.">
    <meta name="author" content="David R. MacIver">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="reveal/css/reveal.css">
    <link rel="stylesheet" href="reveal/css/theme/simple.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="reveal/lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'reveal/css/print/pdf.css' : 'reveal/css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="reveal/lib/js/html5shiv.js"></script>
    <![endif]-->

    <style>
      .reveal h1 { font-size: 1.5em; }
      .reveal h2 { font-size: 1.5em; }
      .reveal h3 { font-size: 1.25em; }
      .reveal pre code {
        padding: 20px 50px 20px 50px !important;
      }
      img {
        border: none !important;
      }
      section.prose ul {
        text-align: left;
      }
      pre.output {
        display: block;
        padding: 2em;
        -moz-box-sizing: border-box;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        overflow: auto;
        max-height: 400px;
        word-wrap: normal;
        background: #3F3F3F;
        color: #DCDCDC;
        font-family: monospace;
      }
      
      .reveal section img.nocomment {
        box-shadow: none;
        margin: auto;
        width: 300px; height: 150px;
      }
    </style>
  </head>

    </style>
  </head>

  <body>

    <div class="reveal">

      <div class="slides">
        <section>
          <h1>The plural of anecdote is not test suite</h1>
          <p><a href=https://bit.ly/plural-of-anecdote-2>https://bit.ly/plural-of-anecdote-2</a></p>
          <p><a href=http://hypothesis.works/>hypothesis.works</a></p>
        </section>

        <section>
          <h1>
            David R. MacIver 
          </h1>
          <p>
            <a href="http://www.drmaciver.com">drmaciver.com</a> / <a href="https://twitter.com/DRMacIver/">@DRMacIver</a>
          </p>
          <p>
            <a href="http://hypothesis.works">hypothesis.works</a>
          </p>
        </section>


        <section>
        <section>
          <h2>Chapter 1</h2>
          <h3>No Mr Bond...</h3>
        </section>


<!--
  Slide 1 (robots): I have an army of robots.
-->

        <section>
        <a href="https://en.wikipedia.org/wiki/File:Kilobot_robot_swarm.JPG"><img src="images/robotswarm.jpg"></a>
        </section>


<!--

  Slide 2: (Genghis Khan): Don't worry, I'm not planning to take over the world with them. Instead I'm using them for a much more specific task.
-->
<section>
<a href="https://en.wikipedia.org/wiki/File:YuanEmperorAlbumGenghisPortrait.jpg"><img src=images/genghiskhan.jpg></a>
</section>
<!--
  Slide 3: (Test) That is, of course, testing.
-->

<section>
<a href="https://en.wikipedia.org/wiki/File:Donboscocambodia0001.JPG"><img src="images/test.jpg"></a>
</section>

<!--
  Slide 4: (Computer) When I say robot army I'm of course being overly dramatic. What I really mean is that to a large degree I have computers doing my testing for me.
           Of course, you probably think you do too.
-->

<section>
<a href="https://en.wikipedia.org/wiki/Commodore_64#/media/File:C64c_system.jpg"><img src=images/computer.jpg></a>
</section>

<!--
  Slide 5: (Hand). The problem is that most automated testing is actually remarkably manual. Every test your computer runs, someone had to write by hand and it only does
           precisely what they told it to do.
-->

<section>
<a href="https://pixabay.com/en/hand-child-black-skin-663725/"><img src="images/hand.jpg"></a>
</section>

<!--
  Slide 6: (Clockwork soldier). This isn't an army of robots, it's an army of clockworks soldiers. You set them on a path, and they go exactly where you tell them to.
           As a result, conventional automated testing doesn't speed up testing, it only speeds up *repeating* testing. The computer doesn't do any work that you haven't
           done yourself at least once. That's still pretty useful, but it's not good enough. 
-->

<section>
<a href="https://commons.wikimedia.org/wiki/File:QSH_Tin_Wind_Up_Mechanical_Robot_(Giant_Easelback_Robot)_Side.jpg"><img src="images/windup-robot.jpg"></a>
</section>

<!--
  Slide 7: (Crowd). The problem with this is that we're outnumbered. We have vastly more users than we do people testing, and that means the majority of the bugs
           are going to be found by your users, not by your testing.
-->
<section><a href="https://www.flickr.com/photos/jamescridland/613445810"><img src=images/crowd.jpg></a></section>
<!--
  Slide 8: (Cash). This is expensive. Bugs found by users not only annoy the users, and potentially lose us custom, they also take much longer to figure out and fix.
           We can throw people at the problem up to a point, but at some point more people becomes more expensive than we save on bugs.
-->

<section><a href="https://commons.wikimedia.org/wiki/File:American_Cash.JPG"><img src=images/cash.jpg></a></section>

<!--
  Slide 9: (Tools). So instead we need to equip ourselves with better tools. I've been spending the last year and a half building them, in the form of a library called
           Hypothesis.People have been using them in production for a while, and it's been going pretty great.
-->


<section><a href="https://commons.wikimedia.org/wiki/File:Hand_tools.jpg"><img src=images/tools.jpg></a></section>
<!--
  Slide 10: (Scientists). It's taken a little bit of science.
-->

<section><a href="https://www.flickr.com/photos/argonne/4534362371/"><img src=images/science.jpg /></a></section>

<!--
  Slide 11: (Eiffel tower). A lot of engineering.
-->

<section><a href="https://commons.wikimedia.org/wiki/File:Tour_Eiffel_Wikimedia_Commons.jpg"><img src="images/eiffel.jpg"></a></section>

<!--
  Slide 12: (Magician's hat). And at least some flat out magic.
-->

<section><a href="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4b/Collapsible_top_hat_IMGP9677.jpg/673px-Collapsible_top_hat_IMGP9677.jpg"><img src=images/tophat.jpg></a></section>

<!--
  Slide 13: (Gears). But at this point, I feel I can confidently say that Hypothesis works.
-->

<section><a href="https://commons.wikimedia.org/wiki/File:Showa_Steel_Works.JPG"><img src=images/steelworks.jpg></a></section>

<!--
  Slide 14: (Construction blocks). And that it's so easy to use, that you too can build your own army of robots.
-->
<section><a href="https://www.flickr.com/photos/82136546@N00/5627007458"><img src=images/legorobot.jpg></a></section>
<!--
  Slide 15: (Question mark). That's about enough advertising, but before I move on to showing you how all of this works out in practice, any questions?
-->

        <section><img class=nocomment  src="images/nocomment.png"></section>

    </section>

        <section>
        <section>
          <h2>Chapter 2</h2>
          <h3>Tests, of a sort</h3>
        </section>

<section>
  <h2>What is a sorted list?</h2>

  <ul>
    <li class=fragment>[1, 2] <span class=fragment>✓</span></li>
    <li class=fragment>[2, 1] <span class=fragment>✘</span></li>
    <li class=fragment>[1, 2, 3] <span class=fragment>✓</span></li>
    <li class=fragment>[3, 2, 1] <span class=fragment>✘</span></li>
    <li class=fragment>[1, 2, 2] <span class=fragment>✓</span></li>
    <li class=fragment>[2, 1, 2] <span class=fragment>✘</span></li>
  </ul>
</section>

<section>
  <h2>How do we sort a list?</h2>

  <ul>
    <li class=fragment>[1, 2] <span class=fragment>→ [1, 2]</span></li>
    <li class=fragment>[2, 1] <span class=fragment>→ [1, 2]</span></li>
    <li class=fragment>[1, 2, 3] <span class=fragment>→ [1, 2, 3]</span></li>
    <li class=fragment>[3, 2, 1] <span class=fragment>→ [1, 2, 3]</span></li>
    <li class=fragment>[1, 2, 2] <span class=fragment>→ [1, 2, 2]</span></li>
    <li class=fragment>[2, 1, 2] <span class=fragment>→ [1, 2, 2]</span></li>
  </ul>
</section>

<section><pre><code class="python" data-trim>
def bubble_sort(ls):
    for i in range(1, len(ls)):
        if ls[i - 1] &gt; ls[i]:
            ls[i - 1], ls[i] = ls[i], ls[i - 1]


def sort(ls):
    result = list(ls)
    bubble_sort(result)
    return result
    
</code></pre></section>

<section><pre><code class="python" data-trim>
def test_example1():
    assert sort([2, 1]) == [1, 2]


def test_example2():
    assert sort([3, 2, 1]) == [1, 2, 3]
</code></pre></section>

<section>

<pre><code class="python" data-trim>
python -m pytest -v test_sorting.py
</code></pre>

<pre class=output>
test_sort.py::test_example1 <span style="color: green">PASSED</span>
test_sort.py::test_example2 <span style="color: red">FAILED</span>

____________________ test_example2 ___________________________
test_sort.py:29: in test_example2
    assert sort([3, 2, 1]) == [1, 2, 3]
E   assert [2, 1, 3] == [1, 2, 3]
E     At index 0 diff: 2 != 1
E     Full diff:
E     - [2, 1, 3]
E     + [1, 2, 3]
</pre></section>

<section><pre><code class="python" data-trim>
def bubble_sort(ls):
    for _ in range(2):
        for i in range(1, len(ls)):
            if ls[i - 1] &gt; ls[i]:
                ls[i - 1], ls[i] = ls[i], ls[i - 1]
</code></pre></section>

<section><pre class=output>
test_sort.py::test_example1 <span style="color: green">PASSED</span>
test_sort.py::test_example2 <span style="color: green">PASSED</span>
</pre></section>

<section>

<pre><code class="python" data-trim>
def test_example3():
    assert sort([4, 3, 2, 1]) == [1, 2, 3, 4]
</code></pre>

<pre class=fragment><code class="python" data-trim>
python -m pytest -v test_sorting.py -k'example3'
</code></pre>

<pre class="fragment output">
test_sort.py::test_example3 <span style="color: red">FAILED</span>

test_sort.py:33: in test_example3
    assert sort([4, 3, 2, 1]) == [1, 2, 3, 4]
E   assert [2, 1, 3, 4] == [1, 2, 3, 4]
E     At index 0 diff: 2 != 1
E     Full diff:
E     - [2, 1, 3, 4]
E     ?     ---
E     + [1, 2, 3, 4]
E     ?  +++
</pre>
</section>

<section><pre><code class="python" data-trim>
def bubble_sort(ls):
    needs_sorting = True
    while needs_sorting:
        needs_sorting = False
        for i in range(1, len(ls)):
            if ls[i - 1] &gt; ls[i]:
                needs_sorting = True
                ls[i - 1], ls[i] = ls[i], ls[i - 1]
</code></pre>


<pre class="fragment output">
test_sort.py::test_example1 <span style="color: green">PASSED</span>
test_sort.py::test_example2 <span style="color: green">PASSED</span>
test_sort.py::test_example3 <span style="color: green">PASSED</span>
</pre></section>

<section>
<pre><code class="python" data-trim>
def is_sorted(ls):
    return all(
        ls[i - 1] &lt;= ls[i]
        for i in range(1, len(ls))
    )
</code></pre>


<pre class=fragment><code class="python" data-trim>
from hypothesis import given
from hypothesis.strategies import lists, integers

@given(lists(integers()))
def test_after_sorting_is_sorted(ls):
    assert is_sorted(sort(ls))
</code></pre>

<pre class="output fragment">
test_sort.py::test_after_sorting_is_sorted <span style="color: green">PASSED</span>
</pre></section>

<section>
<pre><code class="python" data-trim>
def merge_sort(ls):
    if len(ls) &lt;= 1:
        return ls
    else:
        k = len(ls) // 2
        return merge_sorted_lists(
            merge_sort(ls[:k]), merge_sort(ls[k:])
        )


def merge_sorted_lists(x, y):
    ...

</code></pre></section>

<section>
<pre><code class="python" data-trim>
def merge_sorted_lists(x, y):
    result = []
    i = 0
    j = 0
    while i &lt; len(x) and j &lt; len(y):
        if x[i] &lt;= y[j]:
            result.append(x[i])
            i += 1
        else:
            result.append(y[j])
            j += 1
    return result
</code></pre>
<pre class=fragment><code class="python" data-trim>
@given(lists(integers()))
def test_after_merge_sorting_is_sorted(ls):
    assert is_sorted(sort(ls))
</code></pre>
<pre class="output fragment">
test_sort.py::test_after_merge_sorting_is_sorted <span style="color: green">PASSED</span>
</pre></section>

<section>
<pre><code class="python" data-trim>
@given(lists(integers()))
def test_bubble_sorting_is_same_as_merge_sorting(ls):
    assert sort(ls) == merge_sort(ls)

</code></pre>
<pre class="output fragment">
test_sort.py::test_bubble_sorting_is_same_as_merge_sorting <span style="color: red">FAILED</span>

    assert sort(ls) == merge_sort(ls)
E   assert [0, 0] == [0]
E     Left contains more items, first extra item: 0
E     Full diff:
E     - [0, 0]
E     + [0]
---------- Hypothesis ----------
Falsifying example:

  test_bubble_sorting_is_same_as_merge_sorting(ls=[0, 0])
</pre></section>

<section>
<pre><code class="python" data-trim>
@given(lists(integers()), lists(integers()))
def test_merging_sorted_lists_is_sorted(x, y):
    bubble_sort(x)
    bubble_sort(y)
    z = merge_sorted_lists(x, y)
    assert is_sorted(z)
</code></pre>

<pre class="output fragment">
test_sort.py::test_merging_sorted_lists_is_sorted <span style="color: green">PASSED</span>
</pre>

</section>


<section>
<pre><code class="python" data-trim>
@given(lists(integers()), lists(integers()))
def test_merging_sorted_lists_gives_right_number(x, y):
    bubble_sort(x)
    bubble_sort(y)
    z = merge_sorted_lists(x, y)
    assert len(z) == len(x) + len(y)
</code></pre>

<pre class="output fragment">
test_sort.py::test_merging_sorted_lists_gives_right_number <span style="color: red">FAILED</span>

    assert len(z) == len(x) + len(y)
E   assert 0 == (0 + 1)
E    +  where 0 = len([])
E    +  and   0 = len([])
E    +  and   1 = len([0])
---------- Hypothesis ----------
Falsifying example:
  test_merging_sorted_lists_gives_right_number(x=[], y=[0])
</pre>

</section>

<section>
<pre><code class="python" data-trim>
def merge_sorted_lists(x, y):
    result = []
    i = 0
    j = 0
    while i &lt; len(x) and j &lt; len(y):
        if x[i] &lt;= y[j]:
            result.append(x[i])
            i += 1
        else:
            result.append(y[j])
            j += 1
    return result
</code></pre>
</section>

<section>
<pre><code class="python" data-trim>
def merge_sorted_lists(x, y):
    result = []
    i = 0
    j = 0
    while i &lt; len(x) and j &lt; len(y):
        if x[i] &lt;= y[j]:
            result.append(x[i])
            i += 1
        else:
            result.append(y[j])
            j += 1
    result.extend(x[i:])
    result.extend(y[j:])
    return result
</code></pre>
</section>

<section>
<pre class="output">
test_sort.py::test_bubble_sorting_is_same_as_merge_sorting <span style="color: green">PASSED</span>
test_sort.py::test_merging_sorted_lists_is_sorted <span style="color: green">PASSED</span>
test_sort.py::test_merging_sorted_lists_gives_right_number <span style="color: green">PASSED</span>
</pre>
</section>

<section>
<pre><code class="python" data-trim>

def bubble_sort(ls):
    ls.clear()

def merge_sort(ls):
    return []
</code></pre>

<pre class="fragment output">
test_sort.py::test_example1 <span style="color: red">FAILED</span>
test_sort.py::test_example2 <span style="color: red">FAILED</span>
test_sort.py::test_example3 <span style="color: red">FAILED</span>
test_sort.py::test_bubble_sorting_is_same_as_merge_sorting <span style="color: green">PASSED</span>
test_sort.py::test_merging_sorted_lists_is_sorted <span style="color: green">PASSED</span>
test_sort.py::test_merging_sorted_lists_gives_right_number <span style="color: green">PASSED</span>
</pre>
</section>

<section>

<pre><code class="python" data-trim>

@given(st.lists(st.integers()))
def test_sorted_list_has_same_length(ls):
    s = sort(ls)
    assert len(s) == len(ls)
</code></pre>

<pre class="fragment output">
test_sort.py::test_sorted_list_has_same_length <span style="color: red">FAILED</span>


    assert len(s) == len(ls)
E   assert 0 == 1
E    +  where 0 = len([])
E    +  and   1 = len([0])
---------- Hypothesis ----------

Falsifying example: test_sorted_list_has_same_length(ls=[0])
</pre>
</section>

<section>
<pre><code class="python" data-trim>

def bubble_sort(ls):
    for i in range(len(ls)):
        ls[i] = 0

def merge_sort(ls):
    return [0] * len(ls)
</code></pre>

<pre class="fragment output">
test_sort.py::test_sorted_list_has_same_length <span style="color: green">PASSED</span>
</pre>

</section>

<section>
<pre><code class="python" data-trim>
@given(lists(integers()))
def test_sorted_list_has_same_counts(ls):
    s = sort(ls)
    for l in ls:
        assert s.count(l) == ls.count(l)

</code></pre>

<pre class="fragment output">
test_sort.py::test_sorted_list_has_same_counts <span style="color: red">FAILED</span>

E   assert 0 == 1
E    +  where 0 = <built-in method count of list object at 0x7f41cfacde08>(1)
E    +    where <built-in method count of list object at 0x7f41cfacde08> = [0].count
E    +  and   1 = <built-in method count of list object at 0x7f41cfad5e48>(1)
E    +    where <built-in method count of list object at 0x7f41cfad5e48> = [1].count
---------- Hypothesis ----------
Falsifying example:
    test_sorted_list_has_same_counts(ls=[1])
</pre>
</section>


<section><pre><code class="python" data-trim>
def bubble_sort(ls):
    needs_sorting = True
    while needs_sorting:
        needs_sorting = False
        for i in range(1, len(ls)):
            if ls[i - 1] &gt; ls[i]:
                needs_sorting = True
                ls[i - 1], ls[i] = ls[i], ls[i - 1]

def merge_sort(ls):
    if len(ls) &lt;= 1:
        return ls
    else:
        k = len(ls) // 2
        return merge_sorted_lists(
            merge_sort(ls[:k]), merge_sort(ls[k:])
        )

</code></pre></section>

<section>
<pre class=output>
test_sort.py::test_example1 <span style="color: green">PASSED</span>
test_sort.py::test_example2 <span style="color: green">PASSED</span>
test_sort.py::test_example3 <span style="color: green">PASSED</span>
test_sort.py::test_after_sorting_is_sorted <span style="color: green">PASSED</span>
test_sort.py::test_bubble_sorting_is_same_as_merge_sorting <span style="color: green">PASSED</span>
test_sort.py::test_merging_sorted_lists_is_sorted <span style="color: green">PASSED</span>
test_sort.py::test_merging_sorted_lists_gives_right_number <span style="color: green">PASSED</span>
test_sort.py::test_can_split_anywhere <span style="color: green">PASSED</span>
test_sort.py::test_sorted_list_has_same_length <span style="color: green">PASSED</span>
test_sort.py::test_sorted_list_has_same_counts <span style="color: green">PASSED</span>
</pre>
</section>

        <section>
        <img class=nocomment  src="images/nocomment.png">
        </section>


</section>

<section>
<section>
  <h2>Chapter 3</h2>
  <h3>On the heap</h3>
</section>

<section>
  <a href="https://commons.wikimedia.org/wiki/File:Heap_metal.jpg"><img src="images/heap.jpg"></a>
</section>

<section>
  <a href="https://en.wikipedia.org/wiki/File:Min-heap.png"><img src="images/minheap.png"></a>
</section>
      

<section>
<pre><code class="pycon" data-trim>
&gt;&gt;&gt; x = heapnew()
&gt;&gt;&gt; heappush(x, 3)
&gt;&gt;&gt; heappush(x, 5)
&gt;&gt;&gt; heappush(x, 2)
&gt;&gt;&gt; heappop(x)
2
&gt;&gt;&gt; heappop(x)
3
&gt;&gt;&gt; heappop(x)
5
&gt;&gt;&gt; heappop(x)
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "&lt;stdin&gt;", line 4, in heappop
ValueError: Empty heap
</code></pre>
</section>

<section>
<pre><code class="python" data-trim>
def heapnew():
    ...

</code></pre>
</section>

<section>
<pre><code class="python" data-trim>
def heapnew():
    return []

</code></pre>
</section>

<section>
<pre><code class="python" data-trim>
def heapnew():
    return []

def heappush(heap, value):
    ...

</code></pre>
</section>


<section>
<pre><code class="python" data-trim>
def heapnew():
    return []

def heappush(heap, value):
    heap.append(value)
    index = len(heap) - 1
    while index &gt; 0:
        parent = (index - 1) // 2
        if heap[parent] &gt; heap[index]:
            heap[parent], heap[index] = (
                heap[index], heap[parent])
            index = parent
        else:
            break

def heappop(heap):
    ...
</code></pre>
</section>

<section>
<pre><code class="python" data-trim>
def heapnew():
    return []

def heappush(heap, value):
    heap.append(value)
    index = len(heap) - 1
    while index &gt; 0:
        parent = (index - 1) // 2
        if heap[parent] &gt; heap[index]:
            heap[parent], heap[index] = heap[index], heap[parent]
            index = parent
        else:
            break

def heappop(heap):
    return heap.pop(0)
</code></pre>
</section>


<section>
<pre class=stretch><code class="python">

from hypothesis.strategies import integers
from hypothesis.stateful import RuleBasedStateMachine, precondition, rule


class HeapMachine(RuleBasedStateMachine):
    def __init__(self):
        super(HeapMachine, self).__init__()
        self.heap = []

    @rule(value=integers())
    def push(self, value):
        heappush(self.heap, value)

    @rule()
    @precondition(lambda self: self.heap)
    def pop(self):
        correct = min(self.heap)
        result = heappop(self.heap)
        assert correct == result

</code></pre>
</section>

<section>
<pre class="output stretch">

    @rule()
    @precondition(lambda self: self.heap)
    def pop(self):
        correct = min(self.heap)
        result = heappop(self.heap)
&gt;       assert correct == result
<span style="color: red">E       AssertionError: assert 0 == 1</span>

binheap.py:56: AssertionError


---------- Hypothesis ----------

Step #1: push(value=0)
Step #2: push(value=1)
Step #3: push(value=0)
Step #4: pop()
Step #5: pop()
</pre>
</section>

<section>
<pre><code class=pycon>
&gt;&gt;&gt; x = heapnew()
&gt;&gt;&gt; heappush(x, 0); heappush(x, 1); heappush(x, 0);
&gt;&gt;&gt; x
[0, 1, 0]
&gt;&gt;&gt; heappop(x)
0
&gt;&gt;&gt; x
[1, 0]
&gt;&gt;&gt; heappop(x)
1
&gt;&gt;&gt; x
[0]
</pre></code>
</section>


<section>
<pre class=stretch><code class=python data-trim>
def heappop(heap):
    if len(heap) == 0:
        raise ValueError("Empty heap")
    if len(heap) == 1:
        return heap.pop()
    result = heap[0]
    heap[0] = heap.pop()
    index = 0
    while index * 2 + 1 < len(heap):
        children = [index * 2 + 1, index * 2 + 2]
        children = [i for i in children if i &lt; len(heap)]
        children.sort(key=lambda x: heap[x])
        for c in children:
            if heap[index] > heap[c]:
                heap[index], heap[c] = heap[c], heap[index]
                index = c
                break
        else:
            break
    return result
</pre></code>
</section>

<section>
<pre><code class=python data-trim>
def heapmerge(x, y):
    x, y = sorted((x, y))
    return x + y
</pre></code>
</section>

<section>
<pre class=stretch><code class=python data-trim>
from hypothesis.stateful import Bundle

class HeapMachine(RuleBasedStateMachine):
    Heaps = Bundle('heaps')

    @rule(target=Heaps)
    def newheap(self):
        return []

    @rule(heap=Heaps, value=integers())
    def push(self, heap, value):
        heappush(heap, value)

    @rule(heap=Heaps.filter(bool))
    def pop(self, heap):
        correct = min(heap)
        result = heappop(heap)
        assert correct == result

    @rule(target=Heaps, heap1=Heaps, heap2=Heaps)
    def merge(self, heap1, heap2):
        return heapmerge(heap1, heap2)

</pre></code>
</section>

<section>
<pre class="output stretch">

    @rule(heap=Heaps.filter(bool))
    def pop(self, heap):
        correct = min(heap)
        result = heappop(heap)
&gt;       assert correct == result
<span style="color: red">E       AssertionError: assert 0 == 1</span>

binheap.py:105: AssertionError

---------- Hypothesis ----------

Step #1: v1 = newheap()
Step #2: push(heap=v1, value=0)
Step #3: push(heap=v1, value=1)
Step #4: push(heap=v1, value=1)
Step #5: v2 = merge(heap2=v1, heap1=v1)
Step #6: pop(heap=v2)
Step #7: pop(heap=v2)

</pre>
</section>

<section>
<pre><code class=python data-trim>
def heapmerge(x, y):
    result = list(heap1)
    for v in heap2:
        heappush(result, v)
    return result
</pre></code>
</section>

<section>
<pre><code class=python data-trim>
def heapmerge(x, y):
    result = []
    i = 0
    j = 0
    while i &lt; len(x) and j &lt; len(y):
        if x[i] &lt;= y[j]:
            result.append(x[i])
            i += 1
        else:
            result.append(y[j])
            j += 1
    result.extend(x[i:])
    result.extend(y[j:])
    return result
</pre></code>
</section>

<section>
<pre class="output">
Step #1: v1 = newheap()
Step #2: push(heap=v1, value=0)
Step #3: v2 = merge(heap1=v1, heap2=v1)
Step #4: v3 = merge(heap1=v2, heap2=v2)
Step #5: push(heap=v3, value=-1)
Step #6: v4 = merge(heap1=v1, heap2=v2)
Step #7: pop(heap=v4)
Step #8: push(heap=v3, value=-1)
Step #9: v5 = merge(heap1=v1, heap2=v2)
Step #10: v6 = merge(heap1=v5, heap2=v4)
Step #11: v7 = merge(heap1=v6, heap2=v3)
Step #12: pop(heap=v7)
Step #13: pop(heap=v7)
</pre>

<pre><code class=pycon data-trim>
&gt;&gt;&gt; v7
[-1, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0]
</pre></code>

</section>

        <section>
        <img class=nocomment  src="images/nocomment.png">
        </section>

</section>

        <section>
        <section>
          <h2>Epilogue</h2>
        </section>


<section>

<pre class=stretch><code class=java>
public class TestSortingAList {
    @Rule
    public final TestDataRule data = new TestDataRule();

    private &lt;T extends Comparable&lt;T&gt;&gt; void assertSorted(List&lt;T&gt; elements){
        if(elements.isEmpty()) return;
        Iterator&lt;T&gt; it = elements.iterator();
        T previous = it.next();
        while(it.hasNext()){
            T current = it.next();
            assertTrue(previous.compareTo(current) &lt;= 0);
            previous = current;
        }
    }

    @Test
    public void testIsSortedAfterSorting(){
        List&lt;Integer&gt; ls = data.draw(lists(integers()));
        ls.sort(Comparator.naturalOrder());
        assertSorted(ls);
    }
}
</pre></code>
</section>

<section>
<p><a href=*http://hypothesis.works/articles/quickcheck-in-every-language/">hypothesis.works/articles/quickcheck-in-every-language/</a>
</section>

        </section>
        <section>
          <p><span style='font-size: 150px;'>?/!</span></p>
          <p><a href=https://bit.ly/plural-of-anecdote-2>https://bit.ly/plural-of-anecdote-2</a></p>
          <p><a href=http://hypothesis.works>hypothesis.works</a></p>
        </section>

      </div>
    </div>

    <script src="reveal/lib/js/head.min.js"></script>
    <script src="reveal/js/reveal.js"></script>

    <script>

      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'fade',

        dependencies: [
          { src: 'reveal/plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'reveal/plugin/zoom-js/zoom.js', async: true },
          { src: 'reveal/plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>
